# Compiling Java using Bazel

### Compile

1. Compile a Java library:

   <pre textrun="run-console-command">
   bazel build //shared/hello
   </pre>

   This creates
   <code textrun="file-exists">bazel-bin/shared/hello/libhello.jar</code>.

2. Compile a SpringBoot micro-service including all dependencies

   <pre textrun="run-console-command">
   bazel build //app1/service1a:Service1a
   </pre>

3. compile everything:

   <pre textrun="run-console-command">
   bazel build //...
   </pre>

To start over, run `bazel clean` to remove all build artifacts.

### Test

Compile and test everything:

<pre textrun="run-console-command">
bazel test //...
</pre>

Run a single test with output:

<pre textrun="run-console-command">
bazel run //shared/hello:HelloTests
</pre>

### Run

Start the micro-service:

```
bazel run //app1/service1a:Service1a
```

or

```
bazel-bin/app1/service1a/Service1a
```

### Change

- change the `shared.Hello` method to return "Hello world"
- see that it recompiles only this library

Bazel downloads the compilers it uses to compile and run source code as well as
third-party dependencies the source code needs from the internet. This codebase
configures Bazel to use an offline cache for these external dependencies. They
are located in the [dist](dist/) directory. To add missing files, disable your
internet connection and run:

<pre textrun="run-console-command">
bazel build --remote_timeout=1 --keep_going //...
</pre>

If Bazel is missing dependencies, it will print an error. Manually download all
the missing dependencies and put them into the distdir. You also have to list
them in the [WORKSPACE](WORKSPACE) file.

### Maintain

- install the [Bazel build tools](https://github.com/bazelbuild/buildtools)
  (your IDE might do that for you)
- fix all lint errors in Bazel BUILD files:

      buildifier --lint=fix -warnings=native-java -r path/to/your/workspace/root/dir

### Analyze

Which things can Bazel build:

<pre textrun="run-console-command">
bazel query '...' --output label_kind
</pre>

What are the dependencies of the `//app1/service1a:Service1a` package:

<pre textrun="run-console-command">
bazel query "deps(//app1/service1a:Service1a)" --output package
</pre>

Which folders need to be present to build the `//app1/service1a:Service1a`
package:

<pre textrun="run-console-command">
bazel query "buildfiles(deps(//app1/service1a:Service1a))" --output package
</pre>

```
app1/frontend
app1/service1a
shared/hello
shared/login
```

What files are generated by rules in the `//app1/service1a` package:

<pre textrun="run-console-command">
bazel query 'kind("generated file", //app1/service1a:\*)'
</pre>

```
//web:Web_deploy.jar
//web:Web_deploy-src.jar
//web:Web.jar
//web:Web-src.jar
```

Which package contains the file `app1/service1a/Service1a.java`:

<pre textrun="run-console-command">
bazel query app1/service1a/Service1a.java --output package
</pre>

```
//app1/service1a
```

[more info](https://docs.bazel.build/versions/master/query-how-to.html)

### Vendoring

By default, Bazel fetches dependencies from the internet. You can vendor
dependencies. This repo contains vendored dependencies in the [dist](dist/)
folder. Bazel uses this folder automatically thanks to the settings in
[.bazelrc](.bazelrc).

These tasks work offline:

```
bazel build //shared/hello
bazel run //shared/hello:HelloTests
```

### Docker

This project can be run with docker/docker-compose. This allows you to start up
the application without needing java, bazel, node, and npm to be the correct
version, or even installed on your system.

To run this project with docker simply run

```
docker-compose up --build
```

The First build will download the dependencies and take some time, but after
that builds should be as fast as non-docker builds. This setup will also monitor
the filesystem for changes and use bazel to only re-build modified files on
change.
