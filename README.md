# Scalable Build System POC

This is a proof of concept of a mono-repo compiled by the
[scalabel Bazel build system](https://bazel.build).

### Install

- clone this repo

### Compile

1. Compile a Java library:

   ```
   bazel build //src/com/acme/shared/hello
   ```

   This creates `bazel-bin/src/com/acme/shared/hello/libhello.jar`.

2. Compile a SpringBoot micro-service including all dependencies

   ```
   bazel build //src/com/acme/app1/service1a:Service1a
   ```

3. compile everything:

   ```
   bazel build //...
   ```

To start over, run `bazel clean` to remove all build artifacts.

### Test

Compile and test everything:

```
bazel test //...
```

Run a single test with output:

```
bazel run //test/com/acme/shared/hello:HelloTests
```

### Run

Start the micro-service:

```
bazel-bin/src/com/acme/app1/service1a/Service1a
```

### Change

- change the `com.acme.shared.Hello` method to return "Hello world"
- see that it recompiles only this library

### Maintain

- install the [Bazel build tools](https://github.com/bazelbuild/buildtools)
  (your IDE might do that for you)
- fix all lint errors in Bazel BUILD files:

      buildifier --lint=fix -warnings=native-java -r path/to/your/workspace/root/dir

### Analyze

What are the dependencies of the `//src/com/acme/app1/service1a:Service1a`
package:

```
bazel query "deps(//src/com/acme/app1/service1a:Service1a)" --output package
```

Which folders need to be present to build the
`//src/com/acme/app1/service1a:Service1a` package:

```
bazel query "buildfiles(deps(//src/com/acme/app1/service1a:Service1a))" --output package

src/com/acme/shared
src/com/acme/web
src/frontend
```

What files are generated by rules in the `//src/com/acme/web` package:

```
bazel query 'kind("generated file", //src/com/acme/app1/service1a:*)'

//src/com/acme/web:Web_deploy.jar
//src/com/acme/web:Web_deploy-src.jar
//src/com/acme/web:Web.jar
//src/com/acme/web:Web-src.jar
```

Which package contains the file `src/com/acme/app1/service1a/Service1a.java`:

```
bazel query src/com/acme/app1/service1a/Service1a.java --output package

//src/com/acme/app1/service1a
```

[more info](https://docs.bazel.build/versions/master/query-how-to.html)

### Docker

This project can be run with docker/docker-compose. This allows you to start up the application
without needing java, bazel, node, and npm to be the correct version, or even installed on your system.

To run this project with docker simply run
```
docker-compose up --build
```

The First build will download the dependencies and take some time, but after that builds should be as fast as non-docker builds.
This setup will also monitor the filesystem for changes and use bazel to only re-build modified files on change.
