# Scalable Build System POC

This is a proof of concept of a mono-repo compiled by the
[scalabel Bazel build system](https://bazel.build).

### Install

- clone this repo

### Compile

1. Compile a Java library:

   <pre textrun="run-console-command">
   bazel build //java/shared/hello
   </pre>

   This creates
   <code textrun="file-exists">bazel-bin/java/shared/hello/libhello.jar</code>.

2) Compile a SpringBoot micro-service including all dependencies

   <pre textrun="run-console-command">
   bazel build //java/app1/service1a:Service1a
   </pre>

3. compile everything:

   <pre textrun="run-console-command">
   bazel build //...
   </pre>

To start over, run `bazel clean` to remove all build artifacts.

### Test

Compile and test everything:

<pre textrun="run-console-command">
bazel test //...
</pre>

Run a single test with output:

<pre textrun="run-console-command">
bazel run //java/shared/hello:HelloTests
</pre>

### Run

Start the micro-service:

```
bazel run //java/app1/service1a:Service1a
```

or

```
bazel-bin/java/app1/service1a/Service1a
```

### Change

- change the `com.acme.shared.Hello` method to return "Hello world"
- see that it recompiles only this library

### Maintain

- install the [Bazel build tools](https://github.com/bazelbuild/buildtools)
  (your IDE might do that for you)
- fix all lint errors in Bazel BUILD files:

      buildifier --lint=fix -warnings=native-java -r path/to/your/workspace/root/dir

### Analyze

What are the dependencies of the `//java/app1/service1a:Service1a` package:

<pre textrun="run-console-command">
bazel query "deps(//java/app1/service1a:Service1a)" --output package
</pre>

Which folders need to be present to build the `//java/app1/service1a:Service1a`
package:

<pre textrun="run-console-command">
bazel query "buildfiles(deps(//java/app1/service1a:Service1a))" --output package
</pre>

```
java/app1/frontend
java/app1/service1a
java/shared/hello
java/shared/login
```

What files are generated by rules in the `//java/app1/service1a` package:

<pre textrun="run-console-command">
bazel query 'kind("generated file", //java/app1/service1a:\*)'
</pre>

```
//java/web:Web_deploy.jar
//java/web:Web_deploy-src.jar
//java/web:Web.jar
//java/web:Web-src.jar
```

Which package contains the file `java/app1/service1a/Service1a.java`:

<pre textrun="run-console-command">
bazel query java/app1/service1a/Service1a.java --output package
</pre>

```
//java/app1/service1a
```

[more info](https://docs.bazel.build/versions/master/query-how-to.html)

### Docker

This project can be run with docker/docker-compose. This allows you to start up
the application without needing java, bazel, node, and npm to be the correct
version, or even installed on your system.

To run this project with docker simply run

```
docker-compose up --build
```

The First build will download the dependencies and take some time, but after
that builds should be as fast as non-docker builds. This setup will also monitor
the filesystem for changes and use bazel to only re-build modified files on
change.
